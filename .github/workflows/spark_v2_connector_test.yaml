name: "Delta Spark V2 Connector"
# Use pull_request_target so GITHUB_TOKEN has write access for PR comments,
# even on fork-based PRs.
on: [pull_request_target]

permissions:
  pull-requests: write

jobs:
  test:
    name: "V2 Connector: Shard ${{ matrix.shard }}"
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        scala: [2.13.16]
        # Important: This list of shards must be [0..NUM_SHARDS - 1]
        shard: [0, 1, 2, 3]
    env:
      SCALA_VERSION: ${{ matrix.scala }}
      # Important: This must be the same as the length of shards in matrix
      NUM_SHARDS: 4
      # Force all tests to use the Kernel-based V2 connector
      DELTA_V2_ENABLE_MODE: STRICT
    steps:
      - uses: actions/checkout@v3
        with:
          # pull_request_target defaults to base branch; explicitly checkout PR head
          ref: ${{ github.event.pull_request.head.sha }}
      - uses: technote-space/get-diff-action@v4
        id: git-diff
        with:
          PATTERNS: |
            **
            .github/workflows/**
            !unity/**
            !kernel/**
            !connectors/**
      - name: install java
        uses: actions/setup-java@v3
        with:
          distribution: "zulu"
          java-version: "17"
        if: steps.git-diff.outputs.diff
      - name: Cache Scala, SBT
        uses: actions/cache@v3
        with:
          path: |
            ~/.sbt
            ~/.ivy2
            ~/.cache/coursier
          key: delta-sbt-cache-v2connector-scala${{ matrix.scala }}
        if: steps.git-diff.outputs.diff
      - name: Install Job dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y make build-essential libssl-dev zlib1g-dev libbz2-dev libreadline-dev libsqlite3-dev wget curl llvm libncurses5-dev libncursesw5-dev xz-utils tk-dev libffi-dev liblzma-dev python3-openssl git
          sudo apt install libedit-dev
          sudo apt install python3-pip --fix-missing
          sudo pip3 install pipenv==2024.4.1
          curl https://pyenv.run | bash
          export PATH="~/.pyenv/bin:$PATH"
          eval "$(pyenv init -)"
          eval "$(pyenv virtualenv-init -)"
          pyenv install 3.9
          pyenv global system 3.9
          pipenv --python 3.9 install
          pipenv run pip install pip==24.0 setuptools==69.5.1 wheel==0.43.0
        if: steps.git-diff.outputs.diff
      - name: Run Scala/Java tests (V2 Connector STRICT mode)
        id: run-tests
        # Do NOT fail the workflow on test failures; we report results via PR comment
        continue-on-error: true
        run: |
          TEST_PARALLELISM_COUNT=4 pipenv run python run-tests.py --group spark --shard ${{ matrix.shard }}
        if: steps.git-diff.outputs.diff
      - name: Collect test results
        id: collect
        if: always() && steps.git-diff.outputs.diff
        run: |
          # Parse JUnit XML reports generated by SBT/ScalaTest
          python3 - <<'PYEOF'
          import xml.etree.ElementTree as ET
          import glob, json, os

          totals = {"tests": 0, "failures": 0, "errors": 0, "skipped": 0}
          failed_tests = []

          for xml_file in sorted(glob.glob("**/target/test-reports/*.xml", recursive=True)):
              try:
                  tree = ET.parse(xml_file)
                  root = tree.getroot()
                  for ts in ([root] if root.tag == "testsuite" else root.findall(".//testsuite")):
                      totals["tests"] += int(ts.get("tests", 0))
                      totals["failures"] += int(ts.get("failures", 0))
                      totals["errors"] += int(ts.get("errors", 0))
                      totals["skipped"] += int(ts.get("skipped", 0))
                      for tc in ts.findall("testcase"):
                          failure = tc.find("failure")
                          error = tc.find("error")
                          if failure is not None or error is not None:
                              name = f"{tc.get('classname', '')}.{tc.get('name', '')}"
                              msg = ""
                              if failure is not None:
                                  msg = failure.get("message", "")[:200]
                              elif error is not None:
                                  msg = error.get("message", "")[:200]
                              failed_tests.append({"name": name, "message": msg})
              except Exception as e:
                  print(f"Warning: failed to parse {xml_file}: {e}")

          passed = totals["tests"] - totals["failures"] - totals["errors"] - totals["skipped"]

          # Write failed tests to a file for the comment step
          with open("failed-tests-shard-${{ matrix.shard }}.json", "w") as f:
              json.dump(failed_tests, f)

          print(f"Tests: {totals['tests']}, Passed: {passed}, "
                f"Failed: {totals['failures'] + totals['errors']}, Skipped: {totals['skipped']}")
          PYEOF
      - name: Upload test results
        if: always() && steps.git-diff.outputs.diff
        uses: actions/upload-artifact@v4
        with:
          name: v2-test-results-shard-${{ matrix.shard }}
          path: failed-tests-shard-${{ matrix.shard }}.json

  comment:
    name: "V2 Connector: Post Results"
    runs-on: ubuntu-24.04
    needs: test
    if: always()
    steps:
      - uses: actions/download-artifact@v4
        with:
          pattern: v2-test-results-shard-*
          merge-multiple: true
      - name: Build comment body
        run: |
          python3 - <<'PYEOF'
          import json, glob

          all_failed = []
          for f in sorted(glob.glob("failed-tests-shard-*.json")):
              with open(f) as fh:
                  all_failed.extend(json.load(fh))

          total_failed = len(all_failed)
          icon = "âœ…" if total_failed == 0 else "âš ï¸"

          lines = []
          lines.append(f"## {icon} Delta Spark V2 Connector Test Results")
          lines.append("")
          lines.append(f"**Mode:** `DELTA_V2_ENABLE_MODE=STRICT`")
          lines.append("")
          if total_failed == 0:
              lines.append("All tests passed! ðŸŽ‰")
          else:
              lines.append(f"**{total_failed} test(s) failed:**")
              lines.append("")
              lines.append("<details>")
              lines.append("<summary>Click to expand failed tests</summary>")
              lines.append("")
              lines.append("| Test | Message |")
              lines.append("|------|---------|")
              # cap at 10 to avoid huge comments
              for t in all_failed[:10]:
                  name = t["name"].replace("|", "\\|")
                  msg = t["message"].replace("|", "\\|").replace("\n", " ")[:150]
                  lines.append(f"| `{name}` | {msg} |")
              if total_failed > 10:
                  lines.append(f"| ... | *and {total_failed - 10} more* |")
              lines.append("")
              lines.append("</details>")

          body = "\n".join(lines)

          with open("comment_body.md", "w") as f:
              f.write(body)

          print(body)
          PYEOF
      - name: Post PR comment
        uses: mshick/add-pr-comment@v2
        with:
          issue: ${{ github.event.pull_request.number }}
          message-path: comment_body.md
          message-id: v2-connector-test-results
